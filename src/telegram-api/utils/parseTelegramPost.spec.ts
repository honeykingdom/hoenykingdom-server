import path from 'path';
import * as fs from 'fs';
import parseTelegramPost from './parseTelegramPost';

const readFile = (filename: string) =>
  fs.promises.readFile(
    path.resolve('./src/telegram-api/mocks', filename),
    'utf8',
  );

describe('parseTelegramMessage', () => {
  it('should return null with empty args', async () => {
    expect(parseTelegramPost('')).toEqual({
      type: 'not-found',
      post: null,
    });
  });

  it('should parse "post not found"', async () => {
    expect(parseTelegramPost(await readFile('post-not-found.html'))).toEqual({
      type: 'not-found',
      post: null,
    });
  });

  it('should parse text post', async () => {
    expect(parseTelegramPost(await readFile('text-only.html'))).toEqual({
      type: 'post',
      post: {
        id: 40973,
        channel: { id: 1036240821, name: 'meduzalive', title: '–ú–µ–¥—É–∑–∞ ‚Äî LIVE' },
        date: 1618072032000,
        link: 'https://t.me/meduzalive/40973',
        bodyText:
          '–ü–æ—Ö–æ—Ä–æ–Ω—ã —Å—É–ø—Ä—É–≥–∞ –∫–æ—Ä–æ–ª–µ–≤—ã –ï–ª–∏–∑–∞–≤–µ—Ç—ã II, –≥–µ—Ä—Ü–æ–≥–∞ –≠–¥–∏–Ω–±—É—Ä–≥—Å–∫–æ–≥–æ –§–∏–ª–∏–ø–ø–∞ —Å–æ—Å—Ç–æ—è—Ç—Å—è –≤ –í–∏–Ω–¥–∑–æ—Ä–µ 17 –∞–ø—Ä–µ–ª—è. –ò–∑-–∑–∞ –ø–∞–Ω–¥–µ–º–∏–∏ –∫–æ—Ä–æ–Ω–∞–≤–∏—Ä—É—Å–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ü–µ—Ä–µ–º–æ–Ω–∏–∏ –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ. –ü–æ–º–∏–º–æ –Ω–æ—Å–∏–ª—å—â–∏–∫–æ–≤ –≥—Ä–æ–±–∞ –∏ –∞—Ä—Ö–∏–µ–ø–∏—Å–∫–æ–ø–∞ –ö–µ–Ω—Ç–µ—Ä–±–µ—Ä–∏–π—Å–∫–æ–≥–æ, –Ω–∞ –ø–æ—Ö–æ—Ä–æ–Ω–∞—Ö –±—É–¥—É—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å 30 —á–µ–ª–æ–≤–µ–∫. –°—Ä–µ–¥–∏ –Ω–∏—Ö –±—É–¥–µ—Ç –ø—Ä–∏–Ω—Ü –ì–∞—Ä—Ä–∏, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–ª–µ—Ç–∏—Ç –Ω–∞ –ø–æ—Ö–æ—Ä–æ–Ω—ã –∏–∑ –°–®–ê. https://mdza.io/KIvp8C9R7Kg',
        media: [],
      },
    });

    expect(parseTelegramPost(await readFile('text-only-2.html'))).toEqual({
      type: 'post',
      post: {
        id: 40988,
        channel: { id: 1036240821, name: 'meduzalive', title: '–ú–µ–¥—É–∑–∞ ‚Äî LIVE' },
        date: 1618140378000,
        link: 'https://t.me/meduzalive/40988',
        bodyText:
          '–û–∂–∏–¥–∞–Ω–∏–µ: –∫—Ä–∞—Å–∏–≤–æ —É—Ö–æ–¥–∏—à—å –æ—Ç –ø–æ–≥–æ–Ω–∏ –†–µ–∞–ª—å–Ω–æ—Å—Ç—å: –∂–∞—Ä–∏—à—å –∫—É—Ä–∏—Ü—É https://mdza.io/xMT5Sg1Sfss',
        media: [],
      },
    });
  });

  it('should parse service message', async () => {
    expect(parseTelegramPost(await readFile('service-message.html'))).toEqual({
      type: 'service-message',
      post: null,
    });
  });

  it('should parse repost', async () => {
    expect(parseTelegramPost(await readFile('repost.html'))).toEqual({
      type: 'post',
      post: {
        id: 40984,
        channel: { id: 1036240821, name: 'meduzalive', title: '–ú–µ–¥—É–∑–∞ ‚Äî LIVE' },
        forwardedFrom: {
          channelName: 'stopcoronavirusrussia',
          channelTitle: '–°–¢–û–ü–ö–û–†–û–ù–ê–í–ò–†–£–°.–†–§',
          postId: 4268,
        },
        date: 1618129234000,
        link: 'https://t.me/meduzalive/40984',
        bodyText:
          '–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏ –≤ –†–æ—Å—Å–∏–∏ –≤—ã—è–≤–ª–µ–Ω–æ 8 702 —Å–ª—É—á–∞—è COVID-19 –≤ 84 —Ä–µ–≥–∏–æ–Ω–∞—Ö, –∏–∑ –Ω–∏—Ö 1 133 (13,0%) ‚Äî –∞–∫—Ç–∏–≤–Ω–æ —É –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –ª–∏—Ü –±–µ–∑ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—è–≤–ª–µ–Ω–∏–π –±–æ–ª–µ–∑–Ω–∏ ‚ùóÔ∏è –í—Å–µ–≥–æ –≤ —Å—Ç—Ä–∞–Ω–µ –Ω–∞—Ä–∞—Å—Ç–∞—é—â–∏–º –∏—Ç–æ–≥–æ–º –≤—ã—è–≤–ª–µ–Ω–æ 4 641 390 —á–µ–ª–æ–≤–µ–∫ –≤ 85 —Ä–µ–≥–∏–æ–Ω–∞—Ö. –¢–∞–∫–∂–µ –∑–∞ —Å—É—Ç–∫–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ 337 –ª–µ—Ç–∞–ª—å–Ω—ã—Ö –∏—Å—Ö–æ–¥–æ–≤. –ó–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥ –≤ –†–æ—Å—Å–∏–∏ –æ—Ç –∫–æ—Ä–æ–Ω–∞–≤–∏—Ä—É—Å–∞ —Å–∫–æ–Ω—á–∞–ª–æ—Å—å 102 986 —á–µ–ª–æ–≤–µ–∫. –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –≤–∞–∫—Ü–∏–Ω–∞—Ü–∏—é –º–æ–∂–Ω–æ –ø–æ —Å—Å—ã–ª–∫–µ. #—Å—Ç–æ–ø–∫–æ—Ä–æ–Ω–∞–≤–∏—Ä—É—Å #–∑–¥–æ—Ä–æ–≤—å–µ–≤–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ #coronavirus',
        media: [{ type: 'image' }],
      },
    });
  });

  it('should parse reply', async () => {
    expect(parseTelegramPost(await readFile('reply.html'))).toEqual({
      type: 'post',
      post: {
        id: 40957,
        channel: { id: 1036240821, name: 'meduzalive', title: '–ú–µ–¥—É–∑–∞ ‚Äî LIVE' },
        replyTo: {
          postId: 40953,
          channelName: 'meduzalive',
          channelTitle: '–ú–µ–¥—É–∑–∞ ‚Äî LIVE',
          bodyText:
            '¬´–í–∞–∂–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏¬ª —É—Ç–æ—á–Ω–∏–ª–∏, —á—Ç–æ –æ–±—ã—Å–∫ —É –≥–ª–∞–≤—Ä–µ–¥–∞ –∏–∑–¥–∞–Ω–∏—è –†–æ–º–∞–Ω–∞ –ê–Ω–∏–Ω–∞ –ø—Ä–æ—Ö–æ–¥–∏–ª –ø–æ –¥–µ–ª—É –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –Ω–µ–ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–Ω–æ—Å—Ç–∏ —á–∞—Å—Ç–Ω–æ–π –∂–∏–∑–Ω–∏, —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–º –ª–∏—Ü–æ–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–≤–æ–µ–≥–æ —Å–ª—É–∂–µ–±–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è (—á–∞—Å—Ç—å 2 —Å—Ç–∞—Ç—å–∏ 137). –í –∫–∞–∫–æ–º —Å—Ç–∞—Ç—É—Å–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ê–Ω–∏–Ω, –ø–æ–∫–∞ –Ω–µ—è—Å–Ω–æ.',
        },
        date: 1617993506000,
        link: 'https://t.me/meduzalive/40957',
        bodyText:
          '–û–±—ã—Å–∫ —É –≥–ª–∞–≤–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ ¬´–í–∞–∂–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π¬ª –†–æ–º–∞–Ω–∞ –ê–Ω–∏–Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —É–∂–µ –ø—è—Ç—ã–π —á–∞—Å –ø–æ–¥—Ä—è–¥, —Å–æ–æ–±—â–∞–µ—Ç –∂—É—Ä–Ω–∞–ª–∏—Å—Ç –ê–ª–µ—Å—è –ú–∞—Ä–æ—Ö–æ–≤—Å–∫–∞—è.',
        media: [],
      },
    });
  });

  it('should parse post with one image', async () => {
    expect(parseTelegramPost(await readFile('one-image.html'))).toEqual({
      type: 'post',
      post: {
        id: 40978,
        channel: { id: 1036240821, name: 'meduzalive', title: '–ú–µ–¥—É–∑–∞ ‚Äî LIVE' },
        date: 1618076439000,
        link: 'https://t.me/meduzalive/40978',
        bodyText:
          '–í–æ –§—Ä–∞–Ω—Ü–∏–∏ –∞–Ω–æ–º–∞–ª—å–Ω—ã–µ —Ö–æ–ª–æ–¥–∞, –ø—Ä–∏—à–µ–¥—à–∏–µ –≤ 10 –∏–∑ 13 —Ä–µ–≥–∏–æ–Ω–æ–≤ —Å—Ç—Ä–∞–Ω—ã, —É–Ω–∏—á—Ç–æ–∂–∏–ª–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—É—é —á–∞—Å—Ç—å –±—É–¥—É—â–µ–≥–æ —É—Ä–æ–∂–∞—è –≤–∏–Ω–æ–≥—Ä–∞–¥–∞. –í –Ω–∞—á–∞–ª–µ –∞–ø—Ä–µ–ª—è –ø–æ –Ω–æ—á–∞–º –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏—è—Ö —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ–ø—É—Å–∫–∞–ª–∞—Å—å –¥–æ –º–∏–Ω—É—Å –≤–æ—Å—å–º–∏ –≥—Ä–∞–¥—É—Å–æ–≤ –ø–æ –¶–µ–ª—å—Å–∏—é; –º–Ω–æ–≥–∏–µ —Ñ–µ—Ä–º–µ—Ä—ã –ø—ã—Ç–∞–ª–∏—Å—å —Å–æ–≥—Ä–µ—Ç—å –≤–∏–Ω–æ–≥—Ä–∞–¥–Ω–∏–∫–∏, –∑–∞–∂–∏–≥–∞—è —Å–≤–µ—á–∏ –Ω–∞ —É—á–∞—Å—Ç–∫–∞—Ö. –ò–∑-–∑–∞ –∑–∞–º–æ—Ä–æ–∑–∫–æ–≤ —Å–±–æ—Ä—ã –≤–∏–Ω–æ–≥—Ä–∞–¥–∞ –º–æ–≥—É—Ç —Å—Ç–∞—Ç—å –Ω–∞–∏–º–µ–Ω—å—à–∏–º–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 40 –ª–µ—Ç, —Ç–∞–∫–∂–µ –æ–∂–∏–¥–∞—é—Ç—Å—è –Ω–µ—É—Ä–æ–∂–∞–∏ —è–±–ª–æ–∫, –∞–±—Ä–∏–∫–æ—Å–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö —Ç–µ–ø–ª–æ–ª—é–±–∏–≤—ã—Ö –∫—É–ª—å—Ç—É—Ä. –í–ª–∞—Å—Ç–∏ –§—Ä–∞–Ω—Ü–∏–∏ –æ–±—ä—è–≤–∏–ª–∏ —Ä–µ–∂–∏–º —á—Ä–µ–∑–≤—ã—á–∞–π–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –≤ —Å–µ–ª—å—Å–∫–æ–º —Ö–æ–∑—è–π—Å—Ç–≤–µ –∏ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–∏ –º–µ—Ö–∞–Ω–∏–∑–º –≤—ã–ø–ª–∞—Ç –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–π —Ñ–µ—Ä–º–µ—Ä–∞–º –∏–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ñ–æ–Ω–¥–∞.',
        media: [{ type: 'image' }],
      },
    });
  });

  it('should parse post with many images', async () => {
    expect(parseTelegramPost(await readFile('many-images.html'))).toEqual({
      type: 'post',
      post: {
        id: 42166,
        channel: { id: 1005031786, name: 'tvrain', title: '–¢–µ–ª–µ–∫–∞–Ω–∞–ª –î–æ–∂–¥—å' },
        date: 1617980425000,
        link: 'https://t.me/tvrain/42166',
        bodyText:
          '–°–µ–≥–æ–¥–Ω—è —É–º–µ—Ä –ø—Ä–∏–Ω—Ü –§–∏–ª–∏–ø–ø ‚Äî –º—É–∂ –∫–æ—Ä–æ–ª–µ–≤—ã –ï–ª–∏–∑–∞–≤–µ—Ç—ã II. –ß–µ—Ä–µ–∑ –¥–≤–∞ –º–µ—Å—è—Ü–∞ –µ–º—É –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª–Ω–∏—Ç—å—Å—è 100 –ª–µ—Ç. –í –±—Ä–∞–∫–µ —Å –∫–æ—Ä–æ–ª–µ–≤–æ–π –æ–Ω–∏ –ø—Ä–æ–∂–∏–ª–∏ 73 –≥–æ–¥–∞. –í—Å–ø–æ–º–∏–Ω–∞–µ–º –¥–æ–ª–≥—É—é –∏ —è—Ä–∫—É—é –∂–∏–∑–Ω—å –ø—Ä–∏–Ω—Ü–∞. –ë–æ–ª—å—à–µ —Ñ–æ—Ç–æ ‚Äî –≤ –≥–∞–ª–µ—Ä–µ–µ –î–æ–∂–¥—è –§–æ—Ç–æ: PA Wire / TASS; PA Images / TASS; –†–æ–º–∞–Ω –î–µ–Ω–∏—Å–æ–≤ / –¢–ê–°–°; Toby Melville / PA Wire / TASS; Adrian Dennis / AP; Alastair Grant / AP',
        media: [
          { type: 'image' },
          { type: 'image' },
          { type: 'image' },
          { type: 'image' },
          { type: 'image' },
          { type: 'image' },
          { type: 'image' },
        ],
      },
    });
  });

  it('should parse post with one video', async () => {
    expect(parseTelegramPost(await readFile('one-video.html'))).toEqual({
      type: 'post',
      post: {
        id: 42161,
        channel: { id: 1005031786, name: 'tvrain', title: '–¢–µ–ª–µ–∫–∞–Ω–∞–ª –î–æ–∂–¥—å' },
        date: 1617973254000,
        link: 'https://t.me/tvrain/42161',
        bodyText:
          '–ù–∞ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—è ¬´–ê—Ä—Ç–¥–æ–∫—Ñ–µ—Å—Ç–∞¬ª –í–∏—Ç–∞–ª–∏—è –ú–∞–Ω—Å–∫–æ–≥–æ –Ω–∞–ø–∞–ª–∏ –∞–∫—Ç–∏–≤–∏—Å—Ç—ã –≥—Ä—É–ø–ø—ã SERB. –ü–æ–∫–∞ —Ä–µ–∂–∏—Å—Å–µ—Ä –¥–∞–≤–∞–ª –∏–Ω—Ç–µ—Ä–≤—å—é –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∞–º, –∫ –Ω–µ–º—É –ø–æ–¥–±–µ–∂–∞–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ, –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö –ø–æ–ø—ã—Ç–∞–ª—Å—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å –µ–º—É –≥–æ—Ä–ª–æ —Ç–∫–∞–Ω—å—é –í–∏–¥–µ–æ: –î–æ–∂–¥—å',
        media: [{ type: 'video' }],
      },
    });
  });

  it('should parse post with many videos', async () => {
    expect(parseTelegramPost(await readFile('many-videos.html'))).toEqual({
      type: 'post',
      post: {
        id: 42053,
        channel: { id: 1005031786, name: 'tvrain', title: '–¢–µ–ª–µ–∫–∞–Ω–∞–ª –î–æ–∂–¥—å' },
        date: 1617797690000,
        link: 'https://t.me/tvrain/42053',
        bodyText:
          '–ò–∑ –ú–æ—Å–≥–æ—Ä—Å—É–¥–∞ —ç–≤–∞–∫—É–∏—Ä—É—é—Ç –ª—é–¥–µ–π. –°–µ–≥–æ–¥–Ω—è —Ç–∞–º –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –∑–∞—Å–µ–¥–∞–Ω–∏—è –ø–æ ¬´—Å–∞–Ω–∏—Ç–∞—Ä–Ω–æ–º—É –¥–µ–ª—É¬ª –í–∏–¥–µ–æ: –í–∞—Å–∏–ª–∏–π –ö—Ä–µ—Å—Ç—å—è–Ω–∏–Ω–æ–≤; —Ç–µ–ª–µ–≥—Ä–∞–º-–∫–∞–Ω–∞–ª ¬´–ú–µ—Ä–∫—É—Ä–∏¬ª',
        media: [{ type: 'video' }, { type: 'video' }, { type: 'video' }],
      },
    });
  });

  it('should parse post with images and videos', async () => {
    expect(parseTelegramPost(await readFile('videos-and-images.html'))).toEqual(
      {
        type: 'post',
        post: {
          id: 2252,
          channel: {
            id: 1259564118,
            name: 'streaminside',
            title: 'STREAM INSIDE',
          },
          date: 1618133581000,
          link: 'https://t.me/streaminside/2252',
          bodyText:
            "üëÄ –ú–æ—Ä–≥–µ–Ω—à—Ç–µ—Ä–Ω –≤—Å—Ç—Ä–µ—Ç–∏–ª—Å—è —Å ¬´–∫—É–º–∏—Ä–æ–º –≤—Å–µ–π —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏¬ª ‚Äî #Valakas'–æ–º",
          media: [{ type: 'image' }, { type: 'video' }],
        },
      },
    );
  });
});
